{% extends 'base.html' %}
{% block content %}

<div class="videos"></div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const userCode = "{{ user_code }}";  // 사용자 코드를 템플릿에서 가져옴

    const videosWrapper = document.querySelector(".videos");

    const vPlayer = (video) => {
      const videoUrl = video.url ? (video.url.startsWith('/') ? video.url : '/' + video.url) : null;
      const likedClass = video.liked ? 'color-switch' : '';
      return `
        <div class="vdo-wrapper">
          <!-- video -->
          <video src="${videoUrl}" preload="none" loop class="vdo"></video>

          <!-- pause play btn -->
          <button id="pause-play-btn">
            <i class="fa-solid fa-pause"></i>
          </button>

          <!-- side btn -->
          <div class="side-btns-wrapper">
            <button class="control-btn like-btn ${likedClass}" data-video-id="${video.id}" data-liked="${video.liked}">
              <i class="fa-solid fa-thumbs-up"></i>
              <span class="like-count">${video.ft_like}</span>
            </button>
            <button class="control-btn" id="share-btn">
              <i class="fa-solid fa-share"></i>
            </button>
          </div>

          <!-- video info -->
          <div class="info-wrapper">
            <a href="/profile/${video.author_id}"><img src="${video.img}" alt="profile" /></a>
            <div>
              <h3>${video.title}</h3>
              <p>${video.name}</p>
            </div>
          </div>

          <!-- blury background -->
          <div class="blury"></div>

          <!-- comments -->
          <div class="comments">
            <p>Comments</p>
          </div>
        </div>
      `;
    };

    const videoData = JSON.parse('{{ videos | tojson | safe }}');

    function injectVideos() {
      videoData.forEach((video) => {
        const videoElement = vPlayer(video);
        if (videoElement) {
          videosWrapper.innerHTML += videoElement;
        }
      });

      const vids = document.querySelectorAll(".vdo-wrapper");
      vids.forEach((vid) => {
        const vdo = vid.querySelector(".vdo");

        if (vdo) {
          // 화면 내 비디오가 보일 때만 자동 재생
          const intersectionObserver = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
              if (entry.intersectionRatio > 0) {
                vdo.play().catch((error) => {
                  console.log("자동 재생 오류: ", error);
                });
              } else {
                vdo.pause();
              }
            });
          });

          intersectionObserver.observe(vdo);

          const pausePlayBtn = vid.querySelector("#pause-play-btn");
          pausePlayBtn.addEventListener("click", () => {
            if (vdo.paused) {
              vdo.play().catch((error) => {
                console.log("수동 재생 오류: ", error);
              });
              pausePlayBtn.innerHTML = '<i class="fa-solid fa-pause"></i>';
            } else {
              vdo.pause();
              pausePlayBtn.innerHTML = '<i class="fa-solid fa-play"></i>';
            }
          });
        }

        const likeBtn = vid.querySelector(".like-btn");
        const likeCountElement = likeBtn.querySelector(".like-count");

        likeBtn.addEventListener("click", () => {
          const videoId = likeBtn.getAttribute("data-video-id");
          const liked = likeBtn.getAttribute("data-liked") === "true";

          console.log(`Like button clicked: videoId=${videoId}, liked=${liked}`);
          console.log('Current like count element:', likeCountElement);

          if (liked) {
            console.log('Sending unlike request...');
            fetch(`/unlike/${videoId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({ user_code: userCode })
            })
            .then(response => response.json())
            .then(data => {
              console.log('Unlike response:', data);
              if (data.success) {
                console.log('Before update (unlike):', likeCountElement.textContent);
                likeCountElement.textContent = data.likes_count;  // 서버 응답으로 좋아요 수 업데이트
                console.log('Updated like count (unlike):', likeCountElement.textContent);
                likeBtn.setAttribute("data-liked", "false");
                likeBtn.classList.remove("color-switch");
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
          } else {
            console.log('Sending like request...');
            fetch(`/like/${videoId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify({ user_code: userCode })
            })
            .then(response => {
              console.log('Like request sent:', response);
              return response.json();
            })
            .then(data => {
              console.log('Like response:', data);
              if (data.success) {
                console.log('Before update (like):', likeCountElement.textContent);
                likeCountElement.textContent = data.likes_count;  // 서버 응답으로 좋아요 수 업데이트
                console.log('Updated like count (like):', likeCountElement.textContent);
                likeBtn.setAttribute("data-liked", "true");
                likeBtn.classList.add("color-switch");
              } else {
                console.log('Like request failed:', data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
          }
        });

        const shareBtn = vid.querySelector("#share-btn");
        const vidTitle = vid.querySelector(".info-wrapper h3");
        shareBtn.addEventListener("click", () => {
          navigator.share({
            title: vidTitle.textContent,
            text: "Check out this video!",
            url: vdo.src,
          });
        });
      });
    }

    injectVideos();
  });
</script>

{% endblock content %}
