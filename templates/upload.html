{% extends 'base.html' %} {% block content %}
<!--마이페이지 시작-->

<form id="myForm" action="/story" method="post">
  <div class="story_container" style="display: flex">
    <div class="input_text" id="step1" style="flex: 1; padding: 20px">
      <input
        type="text"
        name="keywords"
        placeholder="예시)하늘을 나는 오리 이야기"
        class="input_story"
      />
    </div>
    <button class="base_btn">딸깍</button>
  </div>
  <div style="width: 100%">
    <div style="margin-left: 20px">
      <label for="voices">목소리 선택:</label>
      <select name="selected_voice" id="selected_voice" class="select_v">
        <option
          value="alloy"
          data-image="../static\profile_img/1.png"
          data-audio="../static/profile_audio/alloy.mp3"
        >
          alloy
        </option>
        <option
          value="echo"
          data-image="../static\profile_img/2.png"
          data-audio="../static/profile_audio/echo.mp3"
        >
          echo
        </option>
        <option
          value="fable"
          data-image="../static\profile_img/3.png"
          data-audio="../static/profile_audio/fable.mp3"
        >
          fable
        </option>
        <option
          value="onyx"
          data-image="../static\profile_img/4.png"
          data-audio="../static/profile_audio/onyx.mp3"
        >
          onyx
        </option>
        <option
          value="nova"
          data-image="../static\profile_img/5.png"
          data-audio="../static/profile_audio/nova.mp3"
        >
          nova
        </option>
        <option
          value="shimmer"
          data-image="../static\profile_img/6.png"
          data-audio="../static/profile_audio/shimmer.mp3"
        >
          shimmer
        </option>
        <option value="exp_dir/LeeByongHun.m4a">내목소리</option>
      </select>
    </div>
    <div class="option-container">
      <img
        src="../static/profile_img/1.png"
        alt="선택된 이미지"
        id="selected_image"
        class="option-image"
      />
      <!-- <span id="selected_text"></span> 프로필 밑에 이름-->
    </div>
  </div>
  <div>
    <label for="voices" style="margin-left: 20px">분위기 선택:</label>
    <select name="selected_mood" id="selected_mood" class="select_mood1">
      <option value="peaceful">평화로운</option>

      <option value="touching">신비롭고 감동적인</option>

      <option value="adventurous">모험적인</option>

      <option value="lively">활기찬</option>

      <option value="exciting">신나는</option>

      <option value="nervous">긴장되는</option>
    </select>
  </div>
  <div>
    <label for="voices" style="margin-left: 20px">스타일 선택:</label>
    <select name="changeImg" id="changeImg" class="select_mood1">
      <option
        value="animation style, face and features vibrant and detailed artwork with a serene and warm atmosphere."
        data-image="../static/sample_img/albert-cartoon-dalle3.webp"
      >
        애니메이션
      </option>
      <option
        value="A illustration from a graphic novel."
        data-image="../static/sample_img/anime-dalle.webp"
      >
        노벨
      </option>
      <option
        value="3D style."
        data-image="../static/sample_img/archer-cartoon.webp"
      >
        현실적인
      </option>
      <option
        value="Surreal Desert Oasis style."
        data-image="../static/sample_img/cartoon-disney-dalle-ai.webp"
      >
        듄
      </option>
      <option
        value="cyberpunk portrait style."
        data-image="../static/sample_img/charlie-brown-toon.webp"
      >
        사이버펑크
      </option>
      <option
        value="pixel art style."
        data-image="../static/sample_img/cute-fox-family-toon.webp"
      >
        픽셀
      </option>
    </select>
  </div>
  <img
    src="../static/sample_img/albert-cartoon-dalle3.webp"
    id="selectedImage"
    class="cnImg"
  />
</form>

<section id="loadingContainer" style="display: none">
  <section style="margin-top: 100%">
    <div id="page">
      <div id="phrase_box">
        <svg width="100%" height="100%">
          <defs>
            <mask
              id="mask"
              maskUnits="userSpaceOnUse"
              maskContentUnits="userSpaceOnUse"
            >
              <linearGradient
                id="linearGradient"
                gradientUnits="objectBoundingBox"
                x2="0"
                y2="1"
              >
                <stop stop-color="white" stop-opacity="0" offset="0%" />
                <stop stop-color="white" stop-opacity="1" offset="30%" />
                <stop stop-color="white" stop-opacity="1" offset="70%" />
                <stop stop-color="white" stop-opacity="0" offset="100%" />
              </linearGradient>
              <rect width="100%" height="100%" fill="url(#linearGradient)" />
            </mask>
          </defs>
          <g width="100%" height="100%" style="mask: url(#mask)">
            <g id="phrases"></g>
          </g>
        </svg>
      </div>
      <div id="footer">
        <div id="logo"></div>
        Iforum
      </div>
    </div>
  </section>

  <section class="cube">
    <div class="scene">
      <div class="dodecahedron">
        <div class="wall side"></div>
        <div class="wall side"></div>
        <div class="wall side"></div>
        <div class="wall side"></div>
        <div class="wall side"></div>
        <div class="wall side"></div>
        <div class="wall side"></div>
        <div class="wall side"></div>
        <div class="wall side"></div>
        <div class="wall side"></div>
        <div class="wall lid"></div>
        <div class="wall lid"></div>
      </div>
    </div>
  </section>
</section>

<script>
  // 초기 회전 각도
  let xAngle = 0,
    yAngle = 0;
  let lastTime = 0;

  function rotate(timestamp) {
    if (!lastTime) lastTime = timestamp; // 최초 호출 시간 초기화
    const deltaTime = timestamp - lastTime; // 이전 프레임과의 시간 차이 계산

    // 각도 업데이트 (속도 조절)
    xAngle += (1.6 * deltaTime) / 50; // X축 회전 속도 (델타타임 활용)
    yAngle += (2.7 * deltaTime) / 50; // Y축 회전 속도 (델타타임 활용)

    // 이십면체 요소에 회전 적용
    const dodecahedron = document.querySelector(".dodecahedron");
    dodecahedron.style.transform = `rotateX(${xAngle}deg) rotateY(${yAngle}deg)`;

    lastTime = timestamp; // 현재 호출 시간을 마지막 시간으로 업데이트
    requestAnimationFrame(rotate); // 다음 프레임을 위한 요청
  }

  // 애니메이션 시작
  requestAnimationFrame(rotate);
</script>

<script>
  function createSVG(tag, properties, opt_children) {
    var newElement = document.createElementNS(
      "http://www.w3.org/2000/svg",
      tag
    );
    for (var prop in properties) {
      newElement.setAttribute(prop, properties[prop]);
    }
    if (opt_children) {
      opt_children.forEach(function (child) {
        newElement.appendChild(child);
      });
    }
    return newElement;
  }

  function createPhraseSvg(phrase, yOffset) {
    var text = createSVG("text", {
      fill: "white",
      x: 50,
      y: yOffset,
      "font-size": 18,
      "font-family": "Arial",
    });
    text.appendChild(document.createTextNode(phrase + "..."));
    return text;
  }

  function createCheckSvg(yOffset, index) {
    var check = createSVG("polygon", {
      points:
        "21.661,7.643 13.396,19.328 9.429,15.361 7.075,17.714 13.745,24.384 24.345,9.708 ",
      fill: "rgba(255,255,255,1)",
      id: "loadingCheckSVG-" + index,
    });
    var circle_outline = createSVG("path", {
      d: "M16,0C7.163,0,0,7.163,0,16s7.163,16,16,16s16-7.163,16-16S24.837,0,16,0z M16,30C8.28,30,2,23.72,2,16C2,8.28,8.28,2,16,2 c7.72,0,14,6.28,14,14C30,23.72,23.72,30,16,30z",
      fill: "white",
    });
    var circle = createSVG("circle", {
      id: "loadingCheckCircleSVG-" + index,
      fill: "rgba(255,255,255,0)",
      cx: 16,
      cy: 16,
      r: 15,
    });
    var group = createSVG(
      "g",
      {
        transform: "translate(10 " + (yOffset - 20) + ") scale(.9)",
      },
      [circle, check, circle_outline]
    );
    return group;
  }

  function addPhrasesToDocument(phrases) {
    phrases.forEach(function (phrase, index) {
      var yOffset = 30 + 50 * index;
      document
        .getElementById("phrases")
        .appendChild(createPhraseSvg(phrase, yOffset));
      document
        .getElementById("phrases")
        .appendChild(createCheckSvg(yOffset, index));
    });
  }

  function easeInOut(t) {
    var period = 200;
    return (Math.sin(t / period + 100) + 1) / 2;
  }

  document.addEventListener("DOMContentLoaded", function (event) {
    var phrases = [
      "스토리를 고민하고 있어요...",
      "캐릭터를 구상하고 있어요...",
      "나레이션을 만들고 있어요...",
      "그림을 구상 중이에요",
      "그림을 스케치하고 있어요",
      "물감을 풀고 있어요",
      "그림을 그리고 있어요",
      "그림을 다 그렸어요",
      "영상을 제작 중이에요",
      "잠시만 기다려주세요",
      "스토리를 고민하고 있어요...",
      "캐릭터를 구상하고 있어요...",
      "나레이션을 만들고 있어요...",
      "그림을 구상 중이에요",
      "그림을 스케치하고 있어요",
      "물감을 풀고 있어요",
      "그림을 그리고 있어요",
      "그림을 다 그렸어요",
      "영상을 제작 중이에요",
      "잠시만 기다려주세요",
      "스토리를 고민하고 있어요...",
      "캐릭터를 구상하고 있어요...",
      "나레이션을 만들고 있어요...",
      "그림을 구상 중이에요",
      "그림을 스케치하고 있어요",
      "물감을 풀고 있어요",
      "그림을 그리고 있어요",
      "그림을 다 그렸어요",
      "영상을 제작 중이에요",
      "잠시만 기다려주세요",
    ];
    addPhrasesToDocument(phrases);
    var start_time = new Date().getTime();
    var upward_moving_group = document.getElementById("phrases");
    upward_moving_group.currentY = 0;
    var checks = phrases.map(function (_, i) {
      return {
        check: document.getElementById("loadingCheckSVG-" + i),
        circle: document.getElementById("loadingCheckCircleSVG-" + i),
      };
    });

    function animateLoading() {
      var now = new Date().getTime();
      upward_moving_group.setAttribute(
        "transform",
        "translate(0 " + upward_moving_group.currentY + ")"
      );
      upward_moving_group.currentY -= 1.35 * easeInOut(now);
      checks.forEach(function (check, i) {
        var color_change_boundary = -i * 50 + 50 + 15;
        if (upward_moving_group.currentY < color_change_boundary) {
          var alpha = Math.max(
            Math.min(
              1 -
                (upward_moving_group.currentY - color_change_boundary + 15) /
                  30,
              1
            ),
            0
          );
          check.circle.setAttribute(
            "fill",
            "rgba(255, 255, 255, " + alpha + ")"
          );
          var check_color = [
            Math.round(255 * (1 - alpha) + 120 * alpha),
            Math.round(255 * (1 - alpha) + 154 * alpha),
          ];
          check.check.setAttribute(
            "fill",
            "rgba(255, " + check_color[0] + "," + check_color[1] + ", 1)"
          );
        }
      });
      if (upward_moving_group.currentY <= -1000) {
        upward_moving_group.currentY = 0; // 무한 반복을 위한 위치 재설정
        start_time = new Date().getTime(); // 타이밍을 위한 시작 시간 재설정
      }
      requestAnimationFrame(animateLoading);
    }
    animateLoading();
  });

  document.addEventListener("DOMContentLoaded", () => {
    const selectElement = document.getElementById("selected_voice");
    const selectedImage = document.getElementById("selected_image");
    const selectedText = document.getElementById("selected_text");

    selectElement.addEventListener("change", (event) => {
      const selectedOption = event.target.selectedOptions[0];
      const imageSrc = selectedOption.getAttribute("data-image");
      const text = selectedOption.textContent;
      selectedImage.src = imageSrc;
      selectedText.textContent = text;
    });

    selectedImage.addEventListener("click", () => {
      const selectedOption = selectElement.selectedOptions[0];
      const audioSrc = selectedOption.getAttribute("data-audio");
      if (audioSrc) {
        const audio = new Audio(audioSrc);
        audio.play();
      }
    });

    const imageSelectElement = document.getElementById("changeImg");
    const imageElement = document.getElementById("selectedImage");

    imageSelectElement.addEventListener("change", function () {
      const selectedOption = this.options[this.selectedIndex];
      const imageUrl = selectedOption.getAttribute("data-image");
      imageElement.src = imageUrl;
    });

    const form = document.getElementById("myForm");
    const loadingContainer = document.getElementById("loadingContainer");

    form.addEventListener("submit", function (event) {
      event.preventDefault(); // 폼의 기본 제출 동작 방지
      loadingContainer.style.display = "block";
      form.style.display = "none";
      document.querySelectorAll(".hbody").forEach((element) => {
        element.style.display = "none";
      });

      // 폼 데이터를 수집합니다.
      const formData = new FormData(form);

      // AJAX 요청을 사용하여 폼을 제출합니다.
      fetch(form.action, {
        method: form.method,
        body: formData,
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.url; // 리디렉션된 URL을 받음
        })
        .then((redirectedUrl) => {
          // 페이지를 리디렉션된 URL로 이동
          window.location.href = redirectedUrl;
        })
        .catch((error) => {
          console.error("오류:", error);
          loadingContainer.style.display = "none";
          form.style.display = "block";
          document.querySelectorAll(".hbody").forEach((element) => {
            element.style.display = "block";
          });
        });
    });
  });
</script>

{% endblock content %}
