{% extends 'base.html' %}

{% block content %}
<style>
  .profile-videos .video video {
    width: 300px;
    height: 260px;
    object-fit: cover;
  }

  .profile-img-upload {
    display: none;
    margin-top: 20px;
  }

  .profile-img-upload input[type="file"] {
    display: block;
    margin-bottom: 10px;
  }

  .profile-img-upload button {
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
  }

  .video {
    position: relative;
    display: inline-block;
    margin: 10px;
  }

  .video-controls {
    display: flex;
    justify-content: space-between;
  }

  .like-btn, .delete-btn {
    padding: 5px 10px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    background-color: #f1f1f1;
    border-radius: 5px;
  }

  .like-btn:hover, .delete-btn:hover {
    background-color: #ddd;
  }

  .profile .profile-videos .content {
    position: relative;
    width: 100%;
    height: 24rem;
  }

  .btn {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 10px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 50%;
    transition: background-color 0.3s;
  }

  .btn:active, .btn.recording {
    background-color: red;
  }

  .audio-control {
    margin-top: 20px;
  }

  .recording-indicator {
    display: none;
    color: red;
    font-weight: bold;
    margin-top: 10px;
  }

  .recording .recording-indicator {
    display: inline;
  }

  .recording .btn {
    background-color: red;
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0% {
      background-color: red;
    }
    50% {
      background-color: darkred;
    }
    100% {
      background-color: red;
    }
  }
</style>

<section id="profile" class="box profile">
  <div class="profile-info">
    <div class="profile-img">
      <div class="inner-img">
        <img src="{{ profile_image }}" alt="Profile Image">
      </div>
      <h3>{{ profile_user_info.user_name }}</h3><!-- ì‚¬ìš©ì ì´ë¦„ì„ ì—¬ê¸°ì— í‘œì‹œ -->
    </div>

    <ul>
      <li>
        <h5>{{ follow_count }}</h5>
        <a href="/gudog?user_code={{ profile_user_info.user_code }}">
          <span>íŒ”ë¡œìš°</span>
        </a>
      </li>
      <li>
        <h5>{{ follower_count }}</h5>
        <span>íŒ”ë¡œì›Œ</span>
      </li>
      <li>
        <h5>{{ total_likes }}</h5>
        <span>likes</span>
      </li>
    </ul>

    <div class="buttons">
      {% if is_own_profile %}
      <button class="btn" id="profile-settings-button">í”„ë¡œí•„ì„¤ì •</button>
      {% else %}
        {% if is_following %}
        <button class="btn" id="follow-button" onclick="unfollowUser('{{ profile_user_info.user_code }}')">íŒ”ë¡œìš° ì·¨ì†Œ</button>
        {% else %}
        <button class="btn" id="follow-button" onclick="followUser('{{ profile_user_info.user_code }}')">íŒ”ë¡œìš°</button>
        {% endif %}
      {% endif %}
    </div>

    <form id="uploadForm" onsubmit="uploadVoice(event)">
      <div class="buttons">
        <label for="fileInput">ëª©ì†Œë¦¬ ì²¨ë¶€íŒŒì¼</label>
        <input type="file" id="fileInput" name="file" accept="audio/*" required>
        <label for="voiceName">ëª©ì†Œë¦¬ ì´ë¦„</label>
        <input type="text" id="voiceName" name="voiceName" required>
        <button type="submit" id="submitBtn">ë“±ë¡í•˜ê¸°</button>
      </div>
      <div class="buttons">
        <button type="button" id="rec-btn" class="btn">ë…¹ìŒ ì‹œì‘</button>
        <button type="button" id="stop-rec-btn" class="btn" disabled>ë…¹ìŒ ì¤‘ì§€</button>
        <audio id="audio-playback" controls style="display:none;"></audio>
        <div class="recording-indicator">ë…¹ìŒ ì¤‘...</div>
      </div>
    </form>

    <div class="profile-img-upload" id="profile-img-upload">
      <form action="/upload_profile_image" method="post" enctype="multipart/form-data">
        <input type="file" name="profile_image" accept="image/*" required>
        <button type="submit">ì—…ë¡œë“œ</button>
      </form>
    </div>
  </div>
  
  <div class="profile-videos">
    <div class="content">
      <div class="videos-container">
        {% for fairytale in fairytales %}
        <div class="video" id="video-container-{{ fairytale.ft_code }}">
          <video controls loop autoplay muted>
            <source src="/{{ fairytale.ft_name }}" type="video/mp4">
          </video>
          <div class="video-controls">
            <button class="like-btn" id="like-btn-{{ fairytale.ft_code }}" onclick="toggleLike('{{ fairytale.ft_code }}')">ğŸ‘ Like</button>
            {% if is_own_profile %}
            <button class="delete-btn" onclick="confirmDelete('{{ fairytale.ft_code }}')">ğŸ—‘ï¸</button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ëª©ì†Œë¦¬ ëª©ë¡ -->
  <div class="profile-voices">
    <div class="content">
      <div class="voices-container">
        {% for voice in voices %}
        {% if voice.user_code == current_user_info.usercode %}
        <div class="voice" id="voice-container-{{ voice.voice_code }}">
          <p>{{ voice.voice_name }}</p>
          {% if is_own_profile %}
          <button class="delete-btn" onclick="confirmDeleteVoice('{{ voice.voice_code }}')">ğŸ—‘ï¸ ì‚­ì œ</button>
          {% endif %}
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<script>
// Jinja2ê°€ JSON ë°ì´í„°ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë Œë”ë§í•˜ë„ë¡ í•œë‹¤.

async function uploadVoice(event) {
  event.preventDefault();
  const formData = new FormData(event.target);

  try {
    const response = await fetch('/check_voice_count');
    const data = await response.json();

    if (data.voice_count >= 1) {
      alert('ìµœëŒ€ 1ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      return;
    }
  } catch (error) {
    console.error("Error checking voice count:", error);
    alert('ëª©ì†Œë¦¬ íŒŒì¼ ê°œìˆ˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    return;
  }

  fetch('/upload_voice', {
    method: 'POST',
    body: formData
  }).then(response => {
    if (!response.ok) {
      throw new Error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
    return response.json();
  }).then(data => {
    alert('ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    event.target.reset();
    location.reload();
  }).catch(error => {
    console.error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:', error);
    alert(error.message);
  });
}

async function confirmDeleteVoice(voiceCode) {
  if (confirm("ì •ë§ë¡œ ì´ ëª©ì†Œë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    deleteVoice(voiceCode);
  }
}

async function deleteVoice(voiceCode) {
  fetch(`/delete_voice/${voiceCode}`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json'
    }
  }).then(response => {
    if (!response.ok) {
      throw new Error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
    return response.json();
  }).then(data => {
    alert(data.message);
    document.getElementById(`voice-container-${voiceCode}`).remove();
  }).catch(error => {
    console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:', error);
    alert(error.message);
  });
}

function toggleLike(ftCode) {
  fetch(`/prolike/${ftCode}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    }
  }).then(response => response.json())
    .then(data => {
      alert(`ì´ ì˜ìƒì˜ ì¢‹ì•„ìš” ìˆ˜: ${data.likes_count}`);
    }).catch(error => {
      console.error('ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:', error);
    });
}

function confirmDelete(ftCode) {
  if (confirm("ì •ë§ë¡œ ì´ ë¹„ë””ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    deleteVideo(ftCode);
  }
}

function deleteVideo(ftCode) {
  fetch(`/delete-video/${ftCode}`, {
    method: 'DELETE'
  }).then(response => {
    if (response.ok) {
      return response.json();
    }
    throw new Error('ì„œë²„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
  }).then(data => {
    alert(data.message);  
    document.getElementById(`video-container-${ftCode}`).remove();  // ì •í™•í•œ ID ì‚¬ìš©
  }).catch(error => {
    console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
    alert('ë¹„ë””ì˜¤ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');  // ì‚¬ìš©ìì—ê²Œ ë” ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì œê³µ
  });
}

async function followUser(user_code2) {
  try {
    const response = await fetch(`/follow/${user_code2}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    if (!response.ok) {
      throw new Error('íŒ”ë¡œìš° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
    const data = await response.json();
    alert(data.message);
    document.getElementById('follow-button').innerText = 'íŒ”ë¡œìš° ì·¨ì†Œ';
    document.getElementById('follow-button').setAttribute('onclick', `unfollowUser(${user_code2})`);
  } catch (error) {
    console.error('íŒ”ë¡œìš° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:', error);
    alert(error.message);
  }
}

async function unfollowUser(user_code2) {
  try {
    const response = await fetch(`/unfollow/${user_code2}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    if (!response.ok) {
      throw new Error('ì–¸íŒ”ë¡œìš° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
    const data = await response.json();
    alert(data.message);
    document.getElementById('follow-button').innerText = 'íŒ”ë¡œìš°';
    document.getElementById('follow-button').setAttribute('onclick', `followUser(${user_code2})`);
  } catch (error) {
    console.error('ì–¸íŒ”ë¡œìš° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:', error);
    alert(error.message);
  }
}

document.getElementById('profile-settings-button').addEventListener('click', function () {
  var uploadForm = document.getElementById('profile-img-upload');
  if (uploadForm.style.display === 'none' || uploadForm.style.display === '') {
    uploadForm.style.display = 'block';
  } else {
    uploadForm.style.display = 'none';
  }
});

// ë…¹ìŒ ê¸°ëŠ¥ ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
  const recBtn = document.getElementById('rec-btn');
  const stopRecBtn = document.getElementById('stop-rec-btn');
  const audioPlayback = document.getElementById('audio-playback');
  let mediaRecorder;
  let audioChunks = [];
  let stream;

  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(str => {
      stream = str;
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.onstart = function() {
        audioChunks = [];
        console.log('ë…¹ìŒ ì‹œì‘');
        recBtn.classList.add('recording'); // ë…¹ìŒ ì‹œì‘ ì‹œ ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½
        document.querySelector('.recording-indicator').style.display = 'inline'; // ë…¹ìŒ ì¤‘ í…ìŠ¤íŠ¸ í‘œì‹œ
      };

      mediaRecorder.ondataavailable = function(event) {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = function() {
        console.log('ë…¹ìŒ ì¢…ë£Œ');
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPlayback.src = audioUrl;
        audioPlayback.style.display = 'block';
        stopRecBtn.disabled = true;
        recBtn.disabled = false;
        recBtn.classList.remove('recording'); // ë…¹ìŒ ì¢…ë£Œ ì‹œ ë²„íŠ¼ ìƒ‰ìƒ ì›ë˜ëŒ€ë¡œ
        document.querySelector('.recording-indicator').style.display = 'none'; // ë…¹ìŒ ì¤‘ í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°

        // ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
        stream.getTracks().forEach(track => track.stop());

        // ë…¹ìŒëœ ì˜¤ë””ì˜¤ë¥¼ íŒŒì¼ ì…ë ¥ í•„ë“œì— ì¶”ê°€
        const fileInput = document.getElementById('fileInput');
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(new File([audioBlob], 'recording.wav', { type: 'audio/wav' }));
        fileInput.files = dataTransfer.files;
      };
    })
    .catch(error => console.error('ë¯¸ë””ì–´ ì ‘ê·¼ ì˜¤ë¥˜:', error));

  recBtn.addEventListener('click', function() {
    mediaRecorder.start();
    recBtn.disabled = true;
    stopRecBtn.disabled = false;
  });

  stopRecBtn.addEventListener('click', function() {
    mediaRecorder.stop();
  });
});
</script>
{% endblock content %}
