{% extends 'base.html' %}

{% block content %}
<style>
  .profile-img-upload {
    display: none;
  }

  .recording-indicator {
    display: none;
  }

  .recording {
    background-color: red;
  }



  .rec-bg {

    z-index: 999;
    margin-top: -24%;
    margin-left: -100%;
    background-color: rgba(0, 0, 0, 0.8);
    position: absolute;
    width: 200%;
    height: 600%;
  }

  .delete-btn-v {
    border: none;
    margin-left: 20%;
    font-size: 10px;
    border-radius: 20px;
    padding: 5px;
    background: #ffffc3;
  }
</style>

<section class="pro-h">
  <section id="profile" class="box profile">
    <div class="profile-info">
      <div class="profile-img">
        <div class="inner-img">
          <img src="{{ profile_image }}" alt="Profile Image">
        </div>
        <h3>{{ profile_user_info.user_name }}</h3><!-- ì‚¬ìš©ì ì´ë¦„ì„ ì—¬ê¸°ì— í‘œì‹œ -->
      </div>

      <ul>
        <li>
          <h5>{{ follow_count }}</h5>
          <a href="/gudog?user_code={{ profile_user_info.user_code }}">
            <span>íŒ”ë¡œìš°</span>
          </a>
        </li>
        <li>
          <h5>{{ follower_count }}</h5>
          <span>íŒ”ë¡œì›Œ</span>
        </li>
        <li>
          <h5>{{ total_likes }}</h5>
          <span>ì¢‹ì•„ìš”</span>
        </li>
      </ul>
      <div class="profile-voices">
        <div class="content-v">
          <div class="voices-container">
            {% for voice in voices %}
            <div class="voice" id="voice-container-{{ voice.voice_code }}">
              <p2 class="voice-n">ëª©ì†Œë¦¬:{{ voice.voice_name }}</p2>
              {% if is_own_profile %}
              <button class="delete-btn-v" onclick="confirmDeleteVoice('{{ voice.voice_code }}')">ì‚­ì œí•˜ê¸°</button>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="buttons">
        {% if is_own_profile %}
        <button class="btn" id="profile-settings-button">í”„ë¡œí•„ ì„¤ì •</button>
        <button class="btn" id="rec-btn">ë…¹ìŒ ì‹œì‘</button>
        <button class="btn" id="stop-rec-btn" disabled style="display:none;">ë…¹ìŒ ì¤‘ì§€</button>
        {% else %}
        {% if is_following %}
        <button class="btn" id="follow-button" onclick="unfollowUser('{{ profile_user_info.user_code }}')">íŒ”ë¡œìš°
          ì·¨ì†Œ</button>
        {% else %}
        <button class="btn" id="follow-button" onclick="followUser('{{ profile_user_info.user_code }}')">íŒ”ë¡œìš°</button>
        {% endif %}
        {% endif %}
      </div>

      <div class="profile-img-upload" id="profile-img-upload">
        <form id="uploadProfileImageForm" action="/upload_profile_image" method="post" enctype="multipart/form-data"
          onsubmit="return confirm('í”„ë¡œí•„ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
          <input type="file" id="profileImageInput" name="profile_image" accept="image/*" style="display: none;"
            required>
        </form>
      </div>

      <form id="uploadForm" onsubmit="uploadVoice(event)">
        <div class="buttons" style="display: none;">
          <label for="fileInput">ëª©ì†Œë¦¬ ì²¨ë¶€íŒŒì¼</label>
          <input type="file" id="fileInput" name="file" accept="audio/*" required style="display: none;">
          <label for="voiceName">ëª©ì†Œë¦¬ ì´ë¦„</label>
          <input type="text" id="voiceName" name="voiceName" required>
          <button type="submit" id="submitBtn">ë“±ë¡í•˜ê¸°</button>
        </div>
        <div class="rec-bg" style="display:none;">
          <audio id="audio-playback" controls style="display:none;"></audio>
          <div class="recording-indicator" class="rec-ing">ë…¹ìŒ ì¤‘...</div>
        </div>
      </form>
    </div>

    <div class="profile-videos">
      <div class="content">
        <div class="videos-container">
          {% for fairytale in fairytales %}
          <div class="video" id="video-container-{{ fairytale.ft_code }}">
            <video controls id="video-{{ fairytale.ft_code }}">
              <source src="/{{ fairytale.ft_name }}" type="video/mp4">
            </video>
            <div class="video-controls">
              <button class="like-btn" id="like-btn-{{ fairytale.ft_code }}"
                onclick="toggleLike('{{ fairytale.ft_code }}')">ğŸ‘ ì¢‹ì•„ìš”</button>
              {% if is_own_profile %}
              <button class="delete-btn" onclick="confirmDelete('{{ fairytale.ft_code }}')">ğŸ—‘ï¸ ì‚­ì œ</button>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </section>
</section>
<script>
  async function uploadVoice(event) {
    event.preventDefault();
    const formData = new FormData(event.target);

    try {
      const response = await fetch('/check_voice_count');
      const data = await response.json();

      if (data.voice_count >= 1) {
        if (confirm('í˜„ì¬ ì €ì¥ëœ ëª©ì†Œë¦¬ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤. ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          await fetch('/delete_existing_voice', { method: 'DELETE' });
        } else {
          return;
        }
      }
    } catch (error) {
      console.error("Error checking voice count:", error);
      alert('ëª©ì†Œë¦¬ íŒŒì¼ ê°œìˆ˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return;
    }

    const voiceName = document.getElementById('voiceName').value;
    formData.append('voiceName', voiceName);

    fetch('/upload_voice', {
      method: 'POST',
      body: formData
    }).then(response => {
      if (!response.ok) {
        throw new Error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      return response.json();
    }).then(data => {
      alert('ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      location.reload(); // ì—…ë¡œë“œ ì™„ë£Œ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    }).catch(error => {
      console.error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:', error);
      alert(error.message);
    });
  }

  async function confirmDeleteVoice(voiceCode) {
    if (confirm("ì •ë§ë¡œ ì´ ëª©ì†Œë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      deleteVoice(voiceCode);
    }
  }

  async function deleteVoice(voiceCode) {
    fetch(`/delete_voice/${voiceCode}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(response => {
      if (!response.ok) {
        throw new Error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
      return response.json();
    }).then(data => {
      alert(data.message);
      document.getElementById(`voice-container-${voiceCode}`).remove();
    }).catch(error => {
      console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:', error);
      alert(error.message);
    });
  }

  async function deleteExistingVoice() {
    const response = await fetch('/delete_existing_voice', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error('ê¸°ì¡´ ëª©ì†Œë¦¬ íŒŒì¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }

    const data = await response.json();
    alert(data.message);
  }

  function toggleLike(ftCode) {
    fetch(`/prolike/${ftCode}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    }).then(response => response.json())
      .then(data => {
        alert(`ì˜ìƒì˜ ì¢‹ì•„ìš” ìˆ˜ : ${data.likes_count}`);
      }).catch(error => {
        console.error('ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:', error);
      });
  }

  function confirmDelete(ftCode) {
    if (confirm("ì •ë§ë¡œ ì´ ë¹„ë””ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      deleteVideo(ftCode);
    }
  }

  function deleteVideo(ftCode) {
    fetch(`/delete-video/${ftCode}`, {
      method: 'DELETE'
    }).then(response => {
      if (response.ok) {
        return response.json();
      }
      throw new Error('ì„œë²„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
    }).then(data => {
      alert(data.message);
      document.getElementById(`video-container-${ftCode}`).remove();  // ì •í™•í•œ ID ì‚¬ìš©
    }).catch(error => {
      alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
  }

  async function followUser(user_code2) {
    try {
      const response = await fetch(`/follow/${user_code2}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        alert("íŒ”ë¡œìš° ë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload(); // íŒ”ë¡œìš° í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
      } else {
        alert("íŒ”ë¡œìš° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    } catch (error) {
      console.error("íŒ”ë¡œìš° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:", error);
      alert('íŒ”ë¡œìš° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.');
    }
  }

  async function unfollowUser(user_code2) {
    try {
      const response = await fetch(`/unfollow/${user_code2}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      });

      if (response.ok) {
        alert("íŒ”ë¡œìš° ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload(); // íŒ”ë¡œìš° ì·¨ì†Œ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
      } else {
        alert("íŒ”ë¡œìš° ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    } catch (error) {
      console.error("íŒ”ë¡œìš° ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:", error);
      alert('íŒ”ë¡œìš° ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.');
    }
  }

  document.getElementById('profile-settings-button').addEventListener('click', function () {
    document.getElementById('profileImageInput').click();
  });

  document.getElementById('profileImageInput').addEventListener('change', function () {
    if (confirm('í”„ë¡œí•„ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      document.getElementById('uploadProfileImageForm').submit();
    }
  });

  document.getElementById('fileInput').addEventListener('change', async function () {
    try {
      const response = await fetch('/check_voice_count');
      const data = await response.json();

      if (data.voice_count >= 1) {
        if (confirm('í˜„ì¬ ì €ì¥ëœ ëª©ì†Œë¦¬ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤. ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          await fetch('/delete_existing_voice', { method: 'DELETE' });
        } else {
          return;
        }
      }
    } catch (error) {
      console.error("Error checking voice count:", error);
      alert('ëª©ì†Œë¦¬ íŒŒì¼ ê°œìˆ˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      return;
    }

    const voiceName = prompt("ì—…ë¡œë“œí•  íŒŒì¼ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "íŒŒì¼ ì´ë¦„");
    if (voiceName) {
      document.getElementById('voiceName').value = voiceName;

      // íŒŒì¼ ì—…ë¡œë“œ í¼ì„ ì „ì†¡í•˜ê¸° ì „ì— FormData ê°ì²´ì— íŒŒì¼ ì´ë¦„ì„ ì¶”ê°€
      const uploadForm = document.getElementById('uploadForm');
      const formData = new FormData(uploadForm);
      formData.append('voiceName', voiceName);

      fetch('/upload_voice', {
        method: 'POST',
        body: formData
      }).then(response => {
        if (!response.ok) {
          throw new Error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
        return response.json();
      }).then(data => {
        alert('ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        location.reload(); // ì—…ë¡œë“œ ì™„ë£Œ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
      }).catch(error => {
        console.error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤:', error);
        alert(error.message);
      });
    } else {
      alert('íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
  });

  // ë…¹ìŒ ê¸°ëŠ¥ ì„¤ì •
  document.addEventListener('DOMContentLoaded', async function () {
    const recBtn = document.getElementById('rec-btn');
    const stopRecBtn = document.getElementById('stop-rec-btn');
    const audioPlayback = document.getElementById('audio-playback');
    const voiceNameInput = document.getElementById('voiceName');
    const submitBtn = document.getElementById('submitBtn');
    let mediaRecorder;
    let audioChunks = [];
    let stream;

    async function checkExistingVoice() {
      const response = await fetch('/check_voice_count');
      if (response.ok) {
        const data = await response.json();
        if (data.voice_count > 0) {
          return true;
        }
      }
      return false;
    }

    async function startRecording() {
      const hasExistingVoice = await checkExistingVoice();
      if (hasExistingVoice) {
        if (!confirm('í˜„ì¬ ì €ì¥ëœ ëª©ì†Œë¦¬ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤. ì‚­ì œ í›„ ì§„í–‰í•´ì£¼ì„¸ìš”')) {
          return;
        } else {
          await deleteExistingVoice();
        }
      }

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(str => {
          stream = str;
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.start();
          recBtn.disabled = true;
          stopRecBtn.disabled = false;
          stopRecBtn.style.display = 'inline';

          mediaRecorder.onstart = function () {
            audioChunks = [];
            console.log('ë…¹ìŒ ì‹œì‘');
            recBtn.classList.add('recording');
            document.querySelector('.recording-indicator').style.display = 'inline';
          };

          mediaRecorder.ondataavailable = function (event) {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = async function () {
            console.log('ë…¹ìŒ ì¢…ë£Œ');
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            audioPlayback.src = audioUrl;
            audioPlayback.style.display = 'block';
            stopRecBtn.disabled = true;
            stopRecBtn.style.display = 'none';
            recBtn.disabled = false;
            recBtn.classList.remove('recording');
            document.querySelector('.recording-indicator').style.display = 'none';

            stream.getTracks().forEach(track => track.stop());

            const voiceName = prompt("ë…¹ìŒ íŒŒì¼ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "ë…¹ìŒ íŒŒì¼ ì´ë¦„");
            if (voiceName) {
              const fileInput = document.getElementById('fileInput');
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(new File([audioBlob], `${voiceName}.wav`, { type: 'audio/wav' }));
              fileInput.files = dataTransfer.files;
              voiceNameInput.value = voiceName;
              submitBtn.click(); // ë…¹ìŒì´ ì¤‘ì§€ë˜ë©´ ë“±ë¡í•˜ê¸° ë²„íŠ¼ í´ë¦­
            } else {
              alert('ë…¹ìŒ íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë…¹ìŒ íŒŒì¼ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
          };
        })
        .catch(error => console.error('ë¯¸ë””ì–´ ì ‘ê·¼ ì˜¤ë¥˜:', error));
    }

    async function handleRecBtnClick() {
      const choice = confirm('ë…¹ìŒì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì•„ë‹ˆë©´ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
      if (choice) {
        startRecording();
      } else {
        document.getElementById('fileInput').click();
      }
    }

    recBtn.addEventListener('click', handleRecBtnClick);

    stopRecBtn.addEventListener('click', function () {
      mediaRecorder.stop();
    });

    const hasExistingVoice = await checkExistingVoice();
    if (hasExistingVoice) {
      recBtn.innerText = "ê¸°ì¡´ ëª©ì†Œë¦¬ íŒŒì¼ì´ ìˆìŠµë‹ˆë‹¤";
    }
  });
</script>
{% endblock %}