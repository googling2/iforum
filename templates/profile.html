{% extends 'base.html' %}

{% block content %}
<style>
  .profile-videos .video video {
    width: 300px;
    height: 260px;
    object-fit: cover;
  }
  .profile-img-upload {
    display: none;
    margin-top: 20px;
  }
  .profile-img-upload input[type="file"] {
    display: block;
    margin-bottom: 10px;
  }
  .profile-img-upload button {
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
  }
  .video {
    position: relative;
    display: inline-block;
    margin: 10px;
  }
  .video-controls {
    display: flex;
    justify-content: space-between;
  }
  .like-btn,
  .delete-btn {
    padding: 5px 10px;
    font-size: 16px;
    cursor: pointer;
    border: none;
    background-color: #f1f1f1;
    border-radius: 5px;
  }
  .like-btn:hover,
  .delete-btn:hover {
    background-color: #ddd;
  }
  .profile .profile-videos .content {
    position: relative;
    width: 100%;
    height: 24rem;
  }
</style>
</head>
<body>
<section id="profile" class="box profile">
<div class="top-header">
  <h3>frontend with salimi</h3>
  <div class="icons">
    <i class="fa-solid fa-shoe-prints"></i>
    <i class="fa-solid fa-bars"></i>
  </div>
</div>
<div class="profile-info">
  <div class="profile-img">
    <div class="inner-img">
      <img src="{{ profile_image }}" alt="Profile Image">
    </div>
    <h3>{{ user_info['name'] }}</h3>
  </div>

  <ul>
    <li>
      <h5>115</h5>
      <span>íŒ”ë¡œìš°</span>
    </li>
    <li>
      <h5>3600</h5>
      <span>íŒ”ë¡œì›Œ</span>
    </li>
    <li>
      <h5>{{ total_likes }}</h5>
      <span>likes</span>
    </li>
  </ul>

  <div class="buttons">
    <button class="btn" id="profile-settings-button">í”„ë¡œí•„ì„¤ì •</button>
    <a href="upload.html"><button class="btn">ì—…ë¡œë“œ</button></a>
  </div>

  <!-- íŒŒì¼ ì—…ë¡œë“œ í¼ -->
  <form id="uploadForm" onsubmit="uploadVoice(event)">
    <div class="buttons">
        <label for="fileInput">ëª©ì†Œë¦¬ ì²¨ë¶€íŒŒì¼</label>
        <input type="file" id="fileInput" name="file" accept="audio/*" required>
        <label for="voiceName">ëª©ì†Œë¦¬ ì´ë¦„</label>
        <input type="text" id="voiceName" name="voiceName" required>
        <button type="submit" id="submitBtn">ë“±ë¡í•˜ê¸°</button>
    </div>
  </form>

  <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ í¼ -->
  <div class="profile-img-upload" id="profile-img-upload">
    <form action="/upload_profile_image" method="post" enctype="multipart/form-data">
      <input type="file" name="profile_image" accept="image/*" required>
      <button type="submit">ì—…ë¡œë“œ</button>
    </form>
  </div>
</div>
<div class="profile-videos">
  <div class="content">
    <div class="videos-container">
      {% for fairytale in fairytales %}
      <div class="video" id="video-container-{{ fairytale.ft_code }}">
        <video controls loop autoplay muted>
          <source src="{{ fairytale.ft_name }}" type="video/mp4">
        </video>
        <div class="video-controls">
          <button class="like-btn" id="like-btn-{{ fairytale.ft_code }}" onclick="toggleLike('{{ fairytale.ft_code }}')">
            ğŸ‘ Like
          </button>
          <button class="delete-btn" onclick="confirmDelete('{{ fairytale.ft_code }}')">ğŸ—‘ï¸</button>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ëª©ì†Œë¦¬ ëª©ë¡ -->
<div class="profile-voices">
  <div class="content">
    <div class="voices-container">
      {% for voice in voices %}
      <div class="voice" id="voice-container-{{ voice.voice_code }}">
        <p>{{ voice.voice_name }}</p>
        <button class="delete-btn" onclick="confirmDeleteVoice('{{ voice.voice_code }}')">ğŸ—‘ï¸ ì‚­ì œ</button>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
</section>

<script>
async function uploadVoice(event) {
event.preventDefault();

const formData = new FormData(event.target);

// ì—…ë¡œë“œëœ ëª©ì†Œë¦¬ íŒŒì¼ ìˆ˜ í™•ì¸
try {
    const response = await fetch('/check_voice_count');
    const data = await response.json();
    
    console.log("Voice count data:", data); // ë””ë²„ê¹…ì„ ìœ„í•´ ì¶”ê°€
    if (data.voice_count >= 1) {
        alert('ìµœëŒ€ 1ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
} catch (error) {
    console.error("Error checking voice count:", error);
    alert('ëª©ì†Œë¦¬ íŒŒì¼ ê°œìˆ˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    return;
}

fetch('/upload_voice', {
    method: 'POST',
    body: formData
}).then(response => {
    if (!response.ok) {
        throw new Error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
    return response.json();
}).then(data => {
    alert('ì—…ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
    // í¼ ì´ˆê¸°í™”
    event.target.reset();
    // í•„ìš”í•œ ê²½ìš° ì¶”ê°€ì ì¸ ì‘ì—… ìˆ˜í–‰
    location.reload();  // ì—…ë¡œë“œ ì™„ë£Œ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
}).catch(error => {
    console.error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
    alert(error.message);
});
}

async function confirmDeleteVoice(voiceCode) {
if (confirm("ì •ë§ë¡œ ì´ ëª©ì†Œë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    deleteVoice(voiceCode);
}
}

async function deleteVoice(voiceCode) {
fetch(`/delete_voice/${voiceCode}`, {
    method: 'DELETE',
    headers: {
        'Content-Type': 'application/json'
    }
}).then(response => {
    if (!response.ok) {
        throw new Error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
    return response.json();
}).then(data => {
    alert(data.message);
    document.getElementById(`voice-container-${voiceCode}`).remove();
}).catch(error => {
    console.error('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
    alert(error.message);
});
}

function toggleLike(ftCode) {
fetch(`/like/${ftCode}`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    }
}).then(response => response.json())
  .then(data => {
      alert(`ì´ ì˜ìƒì˜ ì¢‹ì•„ìš” ìˆ˜: ${data.likes_count}`);
  }).catch(error => {
      console.error('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
  });
}

function confirmDelete(ftCode) {
if (confirm("ì •ë§ë¡œ ì´ ë¹„ë””ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
    deleteVideo(ftCode);
}
}

function deleteVideo(ftCode) {
fetch(`/delete-video/${ftCode}`, {
    method: 'DELETE'
}).then(response => {
    if (response.ok) {
        return response.json();
    }
    throw new Error('ì„œë²„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
}).then(data => {
    alert(data.message);  
    document.getElementById(`video-container-${ftCode}`).remove();
}).catch(error => {
    console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
    alert('ë¹„ë””ì˜¤ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
});
}

document.getElementById('profile-settings-button').addEventListener('click', function () {
var uploadForm = document.getElementById('profile-img-upload');
if (uploadForm.style.display === 'none' || uploadForm.style.display === '') {
    uploadForm.style.display = 'block';
} else {
    uploadForm.style.display = 'none';
}
});
</script>
{% endblock content %}
